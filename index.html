<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro Maze 3D</title>
    <style>
        body {
            background-color: #202020;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none; /* Mencegah zoom pada HP */
        }

        h1 {
            font-size: 16px;
            margin: 5px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #88ff88;
        }

        #game-container {
            position: relative;
            border: 4px solid #444;
            background: #000;
            width: 320px;
            height: 240px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated; /* Efek kotak-kotak retro */
            display: block;
        }

        /* Scanlines effect overlay */
        #scanlines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* Controls UI */
        #controls {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 60px 60px 60px;
            grid-gap: 10px;
        }

        .btn {
            background: #333;
            border: 2px solid #00ff00;
            color: #00ff00;
            height: 50px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .btn:active {
            background: #00ff00;
            color: #000;
        }

        .btn-empty {
            border: none;
            background: transparent;
            cursor: default;
        }

        #status {
            margin-top: 10px;
            height: 20px;
            font-size: 14px;
        }

        #win-screen {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            display: none; /* Hidden by default */
            z-index: 10;
        }
        
        #win-screen h2 {
            color: yellow;
            text-shadow: 2px 2px #f00;
        }
    </style>
</head>
<body>

    <h1>Labirin Retro</h1>

    <div id="game-container">
        <canvas id="screen" width="160" height="120"></canvas>
        <div id="scanlines"></div>
        
        <div id="win-screen">
            <h2>ANDA LOLOS!</h2>
            <button class="btn" style="width:120px; font-size:14px;" onclick="location.reload()">Main Lagi</button>
        </div>
    </div>

    <div id="status">Cari Pintu Merah!</div>

    <div id="controls">
        <div class="btn" onclick="rotate(-1)">&#8634;</div>
        <div class="btn" onclick="move(1)">&#8593;</div>
        <div class="btn" onclick="rotate(1)">&#8635;</div>
        
        <div class="btn btn-empty"></div>
        <div class="btn" onclick="move(-1)">&#8595;</div>
        <div class="btn btn-empty"></div>
    </div>

    <script>
        // --- KONFIGURASI GAME ---
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const winScreen = document.getElementById('win-screen');
        const statusText = document.getElementById('status');

        // Peta Labirin: 1 = Dinding, 0 = Jalan, 2 = Pintu Keluar
        // Ukuran peta 10x10
        const mapSize = 10;
        const map = [
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 1, 0, 0, 2, 1],
            [1, 0, 1, 1, 0, 1, 0, 1, 0, 1],
            [1, 0, 1, 0, 0, 0, 0, 1, 0, 1],
            [1, 0, 1, 0, 1, 1, 1, 1, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 0, 1, 1, 0, 1, 0, 1],
            [1, 0, 1, 0, 1, 0, 0, 1, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 1, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
        ];

        // Posisi Pemain
        let playerX = 1.5; // Posisi X (tengah kotak)
        let playerY = 8.5; // Posisi Y (tengah kotak)
        let playerDirX = 0; // Arah pandang X
        let playerDirY = -1; // Arah pandang Y (Menghadap atas)
        let planeX = 0.66; // Bidang kamera (FOV)
        let planeY = 0;

        let gameEnded = false;

        // --- ENGINE RAYCASTING ---
        function draw() {
            // Langit dan Lantai
            ctx.fillStyle = "#111"; // Langit
            ctx.fillRect(0, 0, canvas.width, canvas.height / 2);
            ctx.fillStyle = "#222"; // Lantai
            ctx.fillRect(0, canvas.height / 2, canvas.width, canvas.height / 2);

            // Raycasting Loop
            for (let x = 0; x < canvas.width; x++) {
                // Hitung posisi ray dan arah
                let cameraX = 2 * x / canvas.width - 1;
                let rayDirX = playerDirX + planeX * cameraX;
                let rayDirY = playerDirY + planeY * cameraX;

                // Di kotak mana kita berada di peta
                let mapX = Math.floor(playerX);
                let mapY = Math.floor(playerY);

                // Variabel untuk algoritma DDA (Digital Differential Analyzer)
                let sideDistX, sideDistY;
                let deltaDistX = Math.abs(1 / rayDirX);
                let deltaDistY = Math.abs(1 / rayDirY);
                let perpWallDist;
                let stepX, stepY;
                let hit = 0;
                let side; // 0 untuk dinding Utara/Selatan, 1 untuk Timur/Barat
                let wallType = 0;

                // Hitung step dan sideDist awal
                if (rayDirX < 0) {
                    stepX = -1;
                    sideDistX = (playerX - mapX) * deltaDistX;
                } else {
                    stepX = 1;
                    sideDistX = (mapX + 1.0 - playerX) * deltaDistX;
                }
                if (rayDirY < 0) {
                    stepY = -1;
                    sideDistY = (playerY - mapY) * deltaDistY;
                } else {
                    stepY = 1;
                    sideDistY = (mapY + 1.0 - playerY) * deltaDistY;
                }

                // Lakukan DDA (Mencari dinding)
                while (hit === 0) {
                    if (sideDistX < sideDistY) {
                        sideDistX += deltaDistX;
                        mapX += stepX;
                        side = 0;
                    } else {
                        sideDistY += deltaDistY;
                        mapY += stepY;
                        side = 1;
                    }
                    if (map[mapY][mapX] > 0) {
                        hit = 1;
                        wallType = map[mapY][mapX];
                    }
                }

                // Hitung jarak ke dinding (untuk menghindari efek fisheye)
                if (side === 0) perpWallDist = (mapX - playerX + (1 - stepX) / 2) / rayDirX;
                else perpWallDist = (mapY - playerY + (1 - stepY) / 2) / rayDirY;

                // Hitung tinggi garis yang akan digambar
                let lineHeight = Math.floor(canvas.height / perpWallDist);

                // Hitung pixel awal dan akhir gambar
                let drawStart = -lineHeight / 2 + canvas.height / 2;
                if (drawStart < 0) drawStart = 0;
                let drawEnd = lineHeight / 2 + canvas.height / 2;
                if (drawEnd >= canvas.height) drawEnd = canvas.height - 1;

                // Tentukan warna
                let color;
                if (wallType === 2) {
                    // Pintu Keluar (Merah)
                    color = side === 1 ? "#cc0000" : "#ff0000";
                } else {
                    // Dinding Biasa (Hijau Retro)
                    // Beri shading sedikit gelap jika sisi berbeda untuk efek 3D
                    color = side === 1 ? "#00aa00" : "#00dd00";
                }

                // Gambar garis vertikal
                ctx.fillStyle = color;
                ctx.fillRect(x, drawStart, 1, drawEnd - drawStart);
            }
        }

        // --- LOGIKA GERAK ---
        
        function move(dir) {
            if (gameEnded) return;

            // Kecepatan gerak
            let moveSpeed = 0.5 * dir; // Gerak setengah kotak per tekan

            // Prediksi posisi baru
            let newX = playerX + playerDirX * moveSpeed;
            let newY = playerY + playerDirY * moveSpeed;

            // Cek Tabrakan X (Sederhana)
            // Kita cek margin 0.2 agar tidak menempel dinding
            if (map[Math.floor(playerY)][Math.floor(newX + (dir > 0 ? 0.2 : -0.2) * playerDirX)] === 0 || 
                map[Math.floor(playerY)][Math.floor(newX + (dir > 0 ? 0.2 : -0.2) * playerDirX)] === 2) {
                playerX = newX;
            }

            // Cek Tabrakan Y
            if (map[Math.floor(newY + (dir > 0 ? 0.2 : -0.2) * playerDirY)][Math.floor(playerX)] === 0 || 
                map[Math.floor(newY + (dir > 0 ? 0.2 : -0.2) * playerDirY)][Math.floor(playerX)] === 2) {
                playerY = newY;
            }

            checkWin();
            draw();
        }

        function rotate(dir) {
            if (gameEnded) return;

            // Kecepatan putar
            let rotSpeed = 0.15 * dir; // Sekitar 8-9 derajat per tekan

            // Rumus Rotasi Matriks
            let oldDirX = playerDirX;
            playerDirX = playerDirX * Math.cos(rotSpeed) - playerDirY * Math.sin(rotSpeed);
            playerDirY = oldDirX * Math.sin(rotSpeed) + playerDirY * Math.cos(rotSpeed);
            
            let oldPlaneX = planeX;
            planeX = planeX * Math.cos(rotSpeed) - planeY * Math.sin(rotSpeed);
            planeY = oldPlaneX * Math.sin(rotSpeed) + planeY * Math.cos(rotSpeed);

            draw();
        }

        function checkWin() {
            // Cek apakah pemain berada di dalam kotak dengan nilai 2 (Pintu)
            if (map[Math.floor(playerY)][Math.floor(playerX)] === 2) {
                gameEnded = true;
                winScreen.style.display = "flex";
                statusText.innerText = "SELAMAT! ANDA KELUAR.";
            }
        }

        // --- INPUT KEYBOARD ---
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp' || e.key === 'w') move(1);
            if (e.key === 'ArrowDown' || e.key === 's') move(-1);
            if (e.key === 'ArrowLeft' || e.key === 'a') rotate(-1);
            if (e.key === 'ArrowRight' || e.key === 'd') rotate(1);
        });

        // --- INIT ---
        // Gambar frame pertama
        draw();

    </script>
</body>
</html>
